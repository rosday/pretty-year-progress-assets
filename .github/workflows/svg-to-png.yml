name: Convert SVG to PNG

on:
  push:
    branches: [main]
    paths: ['**/*.svg']

jobs:
  convert-svg-to-png:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with: { fetch-depth: 0 }

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y librsvg2-bin imagemagick fontconfig

      # Use correct path assets/fonts/
      - name: Install custom font system-wide
        run: |
          sudo mkdir -p /usr/share/fonts/truetype/custom
          sudo cp -v assets/fonts/*.ttf /usr/share/fonts/truetype/custom/ 2>/dev/null || true
          sudo cp -v assets/fonts/*.otf /usr/share/fonts/truetype/custom/ 2>/dev/null || true
          sudo fc-cache -f -v                 # rebuild cache
          
          # Create a symlink to ensure the font is found with the exact name
          sudo ln -sf /usr/share/fonts/truetype/custom/SF-Pro-Display-Semibold.otf /usr/share/fonts/truetype/custom/SF\ Pro\ Display\ Semibold.otf 2>/dev/null || true
          sudo ln -sf /usr/share/fonts/truetype/custom/SF-Pro-Display-Regular.otf /usr/share/fonts/truetype/custom/SF\ Pro\ Display.otf 2>/dev/null || true

      - name: Debug – confirm font is visible
        run: |
          fc-list | head -n 20                # show a few fonts
          fc-list | grep -i 'SF Pro Display' || true  # confirm SF Pro Display is installed

      - name: Find changed SVG files
        id: changed
        run: |
          files=$(git diff --name-only HEAD^ HEAD | grep '\.svg$' || true)
          echo "files=$files" >> "$GITHUB_OUTPUT"

      - name: Convert SVG → PNG
        if: steps.changed.outputs.files != ''
        run: |
          for f in ${{ steps.changed.outputs.files }}; do
            png="${f%.svg}.png"
            echo "Converting $f ⇒ $png"
            
            # Use rsvg-convert with additional parameters to ensure font rendering
            rsvg-convert -f png -w 1080 -h 1350 --keep-aspect-ratio --dpi-x 300 --dpi-y 300 "$f" -o "$png"
            
            # Optimize the PNG but maintain quality
            convert "$png" -strip -quality 100 "$png"
          done

      - name: Commit and push PNGs
        if: steps.changed.outputs.files != ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name  "GitHub Action"
          git add "**/*.png"
          git commit -m "Add PNG versions of SVG files" || echo "No PNG changes"
          git push
